<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dziennik kierowcy ‚Äî pary Z/R (PWA)</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<link rel="icon" href="icon-192.png" type="image/png">

<style>
  :root{ --primary:#0d6efd; --bg:#f5f5f5; --card:#fff; --muted:#6c757d; }
  *{ box-sizing:border-box }
  body{ font-family: Arial, sans-serif; background:var(--bg); margin:0; min-height:100vh; display:flex; flex-direction:column;}
  header{ padding:16px 20px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.06); position:sticky; top:0; z-index:10; }
  h1{ margin:0; font-size:22px; text-align:center; color:#000 }
  .container{ padding:20px; display:grid; gap:16px; flex:1; }
  .card{ background:var(--card); border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:16px; }
  label{ display:block; font-weight:700; margin:10px 0 6px }
  input,select,button{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d0d7de; font-size:15px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
  .btn{ background:var(--primary); color:#fff; border:none; cursor:pointer }
  .btn:hover{ filter:brightness(.95) }
  .btn-muted{ background:#6c757d; color:#fff }
  .btn-danger{ background:#dc3545; color:#fff }
  table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden }
  th,td{ padding:10px; border-bottom:1px solid #e9ecef; text-align:center; vertical-align:middle }
  thead th{ background:#eef4ff; font-weight:700 }
  td.place, th.place { text-align:left; }
  .actions{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap }
  .no-print-inline{}
  .print-only{ display:none }
  footer{ text-align:center; padding:14px; color:#666 }
  @media (max-width:760px){ .row,.row-3{ grid-template-columns:1fr } }
  @media print{
    header,.no-print, footer{ display:none !important }
    .no-print-inline{ display:none !important }
    .print-only{ display:block !important; margin-bottom:8pt }
    @page{ size:A4 landscape; margin:12mm }
    table{ table-layout:fixed; width:100%; font-size:12px }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    tr { page-break-inside: avoid; }
    th,td{ text-align:center !important }
    td.place, th.place { text-align:center !important }
  }
</style>
</head>
<body>
<header><h1>üöõ Dziennik kierowcy</h1></header>

<div id="printHeader" class="print-only" style="padding:0 20px;">
  <h2 style="margin:0 0 4pt 0; color:#000;">Dziennik kierowcy</h2>
  <div id="printMeta" style="color:#000;"></div>
</div>

<div class="container">
  <div class="card no-print">
    <div class="row">
      <div>
        <label for="driver">Kierowca (imiƒô i nazwisko)</label>
        <input id="driver" oninput="saveHeader()">
      </div>
      <div>
        <label for="carNo">Nr auta</label>
        <input id="carNo" oninput="saveHeader()">
      </div>
    </div>

    <div class="row-3">
      <div>
        <label for="type">Rodzaj</label>
        <select id="type">
          <option value="Za≈Çadunek">Za≈Çadunek</option>
          <option value="Roz≈Çadunek">Roz≈Çadunek</option>
        </select>
      </div>
      <div>
        <label for="date">Data</label>
        <input type="date" id="date">
      </div>
      <div>
        <label for="odometer">Stan licznika (km)</label>
        <input type="number" id="odometer" inputmode="numeric">
      </div>
    </div>

    <label for="place">Miejsce</label>
    <input id="place">

    <div class="row">
      <button class="btn" onclick="addEntry()">‚ûï Dodaj wpis</button>
      <button class="btn-muted" onclick="exportCSV()">üíæ Eksportuj CSV</button>
    </div>
    <div class="row">
      <button class="btn" onclick="window.print()">üìÑ Zapisz jako PDF</button>
      <button class="btn-danger" onclick="clearLog()">üóëÔ∏è Wyczy≈õƒá wszystko</button>
    </div>
  </div>

  <div class="card">
    <table id="pairTable">
      <thead>
        <tr>
          <th>Data Z.</th><th class="place">Miejsce Z.</th><th>Stan licznika</th>
          <th>Data R.</th><th class="place">Miejsce R.</th><th>Stan licznika</th>
          <th class="no-print-inline">Przebieg (km)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<footer class="no-print">Tw√≥rcy: ≈Åukasz Stasinski & ChatGPT (GPT-5)</footer>

<script>
let entries = [];

if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js');
  });
}

function todayStr(){ return new Date().toISOString().slice(0,10); }
function persist(){ localStorage.setItem('driverLog_pairs_only', JSON.stringify(entries)); }
function byDateTs(a,b){ return a.date.localeCompare(b.date) || a.ts - b.ts; }

function load(){
  try { return JSON.parse(localStorage.getItem('driverLog_pairs_only')) || []; }
  catch { return []; }
}

function nextId(){ return entries.length ? Math.max(...entries.map(e=>e.id))+1 : 1; }

function saveHeader(){
  localStorage.setItem('driverName', document.getElementById('driver').value || '');
  localStorage.setItem('carNumber', document.getElementById('carNo').value || '');
  updatePrintMeta();
}
function updatePrintMeta(){
  const d = localStorage.getItem('driverName') || '-';
  const c = localStorage.getItem('carNumber') || '-';
  document.getElementById('printMeta').textContent = "Kierowca: "+d+" ‚Ä¢ Nr auta: "+c;
}
function setDefaultDate(){
  const dateInput = document.getElementById('date');
  if(!dateInput.value) dateInput.value = todayStr();
  updatePrintMeta();
}

function addEntry(){
  const type=document.getElementById('type').value;
  const date=document.getElementById('date').value||todayStr();
  const place=document.getElementById('place').value.trim();
  const odo=document.getElementById('odometer').value.trim();

  if(!place || !odo){
    alert("Wpisz miejsce i licznik!");
    return;
  }

  entries.push({
    id: nextId(),
    date,
    type,
    place,
    odometer: Number(odo),
    ts: Date.now()
  });

  persist();
  render();

  // czyszczenie p√≥l
  document.getElementById('place').value = "";
  document.getElementById('odometer').value = "";
}

function clearLog(){
  if(confirm("Na pewno usunƒÖƒá wszystkie dane?")){
    entries = [];
    persist();
    render();
  }
}

function render(){
  const tb=document.querySelector('#pairTable tbody');
  tb.innerHTML="";
  const pairs=[]; let load=null;

  entries.sort(byDateTs).forEach(e=>{
    if(e.type==="Za≈Çadunek"){ load=e; }
    else if(load){ pairs.push([load,e]); load=null; }
  });

  pairs.forEach(p=>{
    const delta = p[1].odometer && p[0].odometer ? (p[1].odometer - p[0].odometer) : '';
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p[0].date}</td>
      <td class="place">${p[0].place}</td>
      <td>${p[0].odometer}</td>
      <td>${p[1].date}</td>
      <td class="place">${p[1].place}</td>
      <td>${p[1].odometer}</td>
      <td class="no-print-inline">${delta}</td>
    `;
    tb.appendChild(tr);
  });
}

function exportCSV(){
  let csv="Data Z.,Miejsce Z.,Stan,Data R.,Miejsce R.,Stan,Przebieg\n";
  document.querySelectorAll("#pairTable tbody tr").forEach(tr=>{
    const tds=tr.querySelectorAll("td");
    const row=[...tds].map(td=>td.textContent.replace(/,/g," "));
    csv+=row.join(",")+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="dziennik.csv";
  a.click();
}

window.onload=function(){
  entries=load();
  setDefaultDate();
  render();
};
</script>
</body>
</html>
